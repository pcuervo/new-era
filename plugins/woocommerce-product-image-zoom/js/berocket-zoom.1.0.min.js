/** ////////////////////////////////////////////////////////////////////////////////
// BeRocket Zoom V1.0.1
// (c) 2014 by BeRocket. <http://berocket.com>
// License: GPLv2 or later
// License URI: http://www.gnu.org/licenses/gpl-2.0.html
//
// Please retain this copyright header in all versions of the software
///////////////////////////////////////////////////////////////////////////////// */
(function ($) {

    function format(str) {
        for (var i = 1; i < arguments.length; i++) {
            str = str.replace('%' + (i - 1), arguments[i]);
        }
        return str;
    }

    function BeRocketZoom(jWin, opts) {
        var sImg = $('img', jWin);
		var	img1;
		var	img2;
        var zoomDiv = null;
		var	$mouseTrap = null;
		var	lens = null;
		var	$tint = null;
		var	softFocus = null;
		var	$ie6Fix = null;
		var	zoomImage;
        var controlTimer = 0;      
        var cw, ch;
        var destU = 0;
		var	destV = 0;
        var currV = 0;
        var currU = 0;      
        var filesLoaded = 0;
        var mx,
            my; 
        var ctx = this, zw;

        setTimeout(function () {
            if ($mouseTrap === null) {
                var w = jWin.width();
                jWin.parent().append(format('<div style="width:%0px;position:absolute;top:75%;left:%1px;text-align:center" class="berocket-zoom-loading" >Loading...</div>', w / 3, (w / 2) - (w / 6))).find(':last').css('opacity', 0.5);
            }
        }, 200);

        var ie6FixRemove = function () {
            if ($ie6Fix !== null) {
                $ie6Fix.remove();
                $ie6Fix = null;
            }
        };

        this.removeBits = function () {
            if (lens) {
                lens.remove();
                lens = null;             
            }
            if ($tint) {
                $tint.remove();
                $tint = null;
            }
            if (softFocus) {
                softFocus.remove();
                softFocus = null;
            }
            ie6FixRemove();

            $('.berocket-zoom-loading', jWin.parent()).remove();
        };


        this.destroy = function () {
            jWin.data('zoom', null);

            if ($mouseTrap) {
                $mouseTrap.unbind();
                $mouseTrap.remove();
                $mouseTrap = null;
            }
            if (zoomDiv) {
                zoomDiv.remove();
                zoomDiv = null;
            }
            this.removeBits();
        };


        // This is called when the zoom window has faded out so it can be removed.
        this.fadedOut = function () {
            
			if (zoomDiv) {
                zoomDiv.remove();
                zoomDiv = null;
            }
			 this.removeBits();
        };

        this.controlLoop = function () {
			var x = (mx - $mouseTrap.offset().left - (cw * 0.5)) >> 0;
			var y = (my - $mouseTrap.offset().top - (ch * 0.5)) >> 0;
			
		   
			if (x < 0) {
				x = 0;
			}
			else if (x > ($mouseTrap.outerWidth() - cw)) {
				x = ($mouseTrap.outerWidth() - cw);
			}
			if (y < 0) {
				y = 0;
			}
			else if (y > ($mouseTrap.outerHeight() - ch)) {
				y = ($mouseTrap.outerHeight() - ch);
			}

			destU = (((x) / $mouseTrap.outerWidth()) * zoomImage.width) >> 0;
			destV = (((y) / $mouseTrap.outerHeight()) * zoomImage.height) >> 0;
			currU += (destU - currU) / opts.smoothMove;
			currV += (destV - currV) / opts.smoothMove;
			
			zoomDiv.css('background-position', (-(currU >> 0) + 'px ') + (-(currV >> 0) + 'px'));
            
            controlTimer = setTimeout(function () {
                ctx.controlLoop();
            }, 30);
        };
        
        this.findLocations = function (is_mobile){
			if( is_mobile ){
				width = $(window).width();
				height = $(window).height();
				
				left = top_ = 0;
			}else{
				iw = zoomImage.width >> 0;
				ih = zoomImage.height >> 0;
				
				ww = $(window).width() >> 0;
				wh = $(window).height() >> 0;
				
				width = ww - 100;
				height = wh - 100;
				
				left = top_ = 50;
				
				if( ww > iw + 100 ){
					width = iw;
					left = ( ww - iw ) / 2;
				}
				
				if( wh > ih + 100 ){
					height = ih;
					top_ = ( wh - ih ) / 2;
				}
			}
			zoomDiv.css({ width: width, height: height, left: left, top: top_ });
			$mouseTrap.css({ width: width, height: height, left: left, top: top_ });
		};

        this.init2 = function (img, id) {
            filesLoaded++;
            if (id === 1) {
                zoomImage = img;
            }
            
            if (filesLoaded === 2) {
                this.init();
            }
        };

        this.init = function () {
            $('.berocket-zoom-loading', jWin.parent()).remove();
			
            $mouseTrap = jWin.parent().append(format("<div class='mousetrap' style='background-image:url(\".\");width:%0px;height:%1px;left:%2px;top:%3px;\'></div>", sImg.outerWidth(), sImg.outerHeight(), 0, 0)).find(':last');
			
			var touchy=("ontouchstart" in document.documentElement)?true:false;
			var m_move='touchmove mousemove';
			var m_end='touchend mouseleave';
			var m_ent='touchstart mouseenter';
			var m_click='touchstart click';

            if( touchy ){
                $mouseTrap.bind('touchmove', this, function (e) {
                    mx=( typeof(e.originalEvent.touches) !='undefined')?e.originalEvent.touches[0].pageX:e.pageX;my=( typeof(e.originalEvent.touches) !='undefined')?e.originalEvent.touches[0].pageY:e.pageY;
                });
                $mouseTrap.bind('touchend', this, function (event) {
                    clearTimeout(controlTimer);
                    $mouseTrap.removeClass('active').appendTo( jWin.parent() ).css({ top: 0, left: 0, width: sImg.width(), height: sImg.height() });
                    zoomDiv.fadeOut(300, function () {
                        ctx.fadedOut();
                    });
                    return false;
                });
                $mouseTrap.bind('touchstart', this, function (event) {
                    event.preventDefault();
                    mx=( typeof(event.originalEvent.touches) !='undefined')?event.originalEvent.touches[0].pageX:event.pageX;
                    my=( typeof(event.originalEvent.touches) !='undefined')?event.originalEvent.touches[0].pageY:event.pageY;

                    zw = event.data;
                    if (zoomDiv) {
                        zoomDiv.stop(true, false);
                        zoomDiv.remove();
                    }
                    $mouseTrap.appendTo( $('body') ).addClass('active is_mobile');
                    zoomDiv = $( format('<div id="berocket-zoom-big" class="berocket-zoom-big" style="background-image:url(\'%0\');"></div>', zoomImage.src) ).appendTo( $('body') ).addClass('is_mobile');
                    zw.findLocations(true);

                    zoomDiv.fadeIn(500);

                    cw = ($mouseTrap.outerWidth() / zoomImage.width) * zoomDiv.width();
                    ch = ($mouseTrap.outerHeight() / zoomImage.height) * zoomDiv.height();

                    zw.controlLoop();
                    return;
                });
            }else{
				$mouseTrap.bind('mousemove', this, function (e) {
					mx=( typeof(e.originalEvent.touches) !='undefined')?
							e.originalEvent.touches[0].pageX:e.pageX;
					my=( typeof(e.originalEvent.touches) !='undefined')?
							e.originalEvent.touches[0].pageY:e.pageY;
				});
				$mouseTrap.bind('click', this, function (event) {
					if( zoomDiv ){
						clearTimeout(controlTimer);
						$mouseTrap.removeClass('active').appendTo( jWin.parent() ).css({ top: 0, left: 0, width: sImg.width(), height: sImg.height() });
						$('.submousetrap').remove();
						$('.fancybox-close').remove();
						zoomDiv.fadeOut(300, function () {
							ctx.fadedOut();
						});																
						return false;
					}else{
						mx = event.pageX;
						my = event.pageY;
						
						zw = event.data;
						if (zoomDiv) {
							zoomDiv.stop(true, false);
							zoomDiv.remove();
						}
						
						$mouseTrap.appendTo( $('body') ).addClass('active');
						zoomDiv = $( format('<div id="berocket-zoom-big" class="berocket-zoom-big" style="background-image:url(\'%0\');"></div>', zoomImage.src) ).appendTo( $('body') );
						zw.findLocations();
						
						submousetrap = $("<div class='submousetrap' />").appendTo( $('body') );
						fancyboxclose = $('<a href="#" class="fancybox-close" title="Close"></a>').appendTo($mouseTrap);
						submousetrap.bind('click', this, function (event) {
							clearTimeout(controlTimer);
							$mouseTrap.removeClass('active').appendTo( jWin.parent() ).css({ top: 0, left: 0, width: sImg.width(), height: sImg.height() });
							$('.submousetrap').remove();
							$('.fancybox-close').remove();
							zoomDiv.fadeOut(300, function () {
								ctx.fadedOut();
							});																
						return false;
						});
						fancyboxclose.bind('click', this, function (event) {
							clearTimeout(controlTimer);
							$mouseTrap.removeClass('active').appendTo( jWin.parent() ).css({ top: 0, left: 0, width: sImg.width(), height: sImg.height() });
							$('.submousetrap').remove();
							$('.fancybox-close').remove();
							zoomDiv.fadeOut(300, function () {
								ctx.fadedOut();
							});																
							return false;
						});
						
						zoomDiv.fadeIn(500);
						
						cw = ($mouseTrap.outerWidth() / zoomImage.width) * zoomDiv.width();
						ch = ($mouseTrap.outerHeight() / zoomImage.height) * zoomDiv.height();

						zw.controlLoop();
						return;
					}
				});
			}
        };

        img1 = new Image();
        $(img1).load(function () {
            ctx.init2(this, 0);
        });
        img1.src = sImg.attr('src');

        img2 = new Image();
        $(img2).load(function () {
            ctx.init2(this, 1);
        });
        img2.src = jWin.attr('href');
    }

    $.fn.BeRocketZoom = function (options) {
        try {
            document.execCommand("BackgroundImageCache", false, true);
        } catch (e) {}
        this.each(function () {
			var	relOpts, opts;
			eval('var	a = {' + $(this).attr('rel') + '}');
			relOpts = a;
            if ($(this).is('.berocket-zoom')) {
                $(this).css({
                    'position': 'relative',
                    'display': 'block'
                });
                $('img', $(this)).css({
                    'display': 'block'
                });
                if ($(this).parent().attr('id') != 'wrap') {
                    $(this).wrap('<div id="wrap" style="top:0px;z-index:999;position:relative;"></div>');
                }
                opts = $.extend({}, $.fn.BeRocketZoom.defaults, options);
                opts = $.extend({}, opts, relOpts);
                $(this).data('zoom', new BeRocketZoom($(this), opts));

            } else if ($(this).is('.berocket-zoom-gallery')) {
                opts = $.extend({}, relOpts, options);
                $(this).data('relOpts', opts);
                $(this).bind(m_click, $(this), function (event) {
                    var data = event.data.data('relOpts');
                    $('#' + data.useZoom).data('zoom').destroy();
                    $('#' + data.useZoom).attr('href', event.data.attr('href'));
                    $('#' + data.useZoom + ' img').attr('src', event.data.data('relOpts').smallImage);
                    $('#' + event.data.data('relOpts').useZoom).BeRocketZoom();
                    return false;
                });
            }
        });
        return this;
    };

    $.fn.BeRocketZoom.defaults = {
        zoomWidth: 'auto',
        zoomHeight: 'auto',
        position: 'right',
        tint: false,
        tintOpacity: 0.5,
        lensOpacity: 0.5,
        softFocus: false,
        smoothMove: 3,
        showTitle: true,
        titleOpacity: 0.5,
        adjustX: 0,
        adjustY: 0
    };
    
    $('.product .images').on('click', 'a', function (event){
		event.preventDefault();
	});
    $('.berocket-zoom').on('click', 'a', function (event){
		event.preventDefault();
	});

})(jQuery);